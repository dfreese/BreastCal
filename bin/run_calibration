#!/usr/bin/env python

import os
import json
import subprocess
import argparse
import re

def parse_args():
    # see https://docs.python.org/2/library/argparse.html for reference
    parser = argparse.ArgumentParser(
            description='Run calibration on collected data')
    parser.add_argument('--cores',
            help='Number of simultaneous instances to run if necessary',
            type=int,
            default=4)
    parser.add_argument('-c', '--config',
            help='Calibration Config Json with breast_daq_config "config_file"',
            type=str)
    parser.add_argument('-b', '--blank',
            help='Generate a blank json config',
            type=str)
    parser.add_argument('-g', '--generate',
            help='Auto generate a json config from the base name given',
            default=None,
            type=str,
            action='store',
            const=True,
            nargs='?')
    parser.add_argument('-s', '--simulate',
            help='Just print out the commands, but do not run them',
            action='store_true')
    parser.add_argument('-d', '--decode',
            help='Decode all of the data files',
            action='store_true')
    parser.add_argument('-cal', '--calibrate',
            help='Decode all of the data files',
            action='store_true')
    parser.add_argument('-ad', '--assume_decoded',
            help='Assume the files have been decoded for calibration',
            action='store_true')
    parser.add_argument('-a', '--all',
            help='Run all of the calibrations',
            action='store_true')
    parser.add_argument('-p', '--pedestals',
            help='Calculate pedestals from "ped_filelist" into "ped_file"',
            action='store_true')
    parser.add_argument('-u', '--uv',
            help='Calculate uv from "filelist" into "uv_file"',
            action='store_true')
    parser.add_argument('-app', '--apd_photopeaks',
            help='Calculate the APD photopeaks from "filelist" ' +
                 'into "pp_file" and generate energy histograms in ' +
                 '"pp_root_file"',
            action='store_true')
    parser.add_argument('-fillf', '--fill_floods',
            help='Fill floods from "filelist" into "flood_root_file"',
            action='store_true')
    parser.add_argument('-fitf', '--fit_floods',
            help='Fit floods in "flood_root_file" and write the crystal ' +
                  'positions to "loc_file" and place the root graphs in ' +
                  '"graphs_root_file"',
            action='store_true')
    parser.add_argument('-cpp', '--crystal_photopeaks',
            help='Calculate the crystal photopeaks from "filelist" ' +
                 'and generate "cal_file" and generate energy histograms in ' +
                 '"crystal_energy_root_file"',
            action='store_true')

    return parser

def generate_blank_config(filename):
    blank_config = dict()
    blank_config['config_file'] = ''
    blank_config['ped_filelist'] = ''
    blank_config['ped_file'] = ''
    blank_config['filelist'] = ''
    blank_config['dec_filelist'] = ''
    blank_config['cal_filelist'] = ''
    blank_config['uv_file'] = ''
    blank_config['pp_file'] = ''
    blank_config['pp_root_file'] = ''
    blank_config['flood_root_file'] = ''
    blank_config['loc_file'] = ''
    blank_config['graphs_root_file'] = ''
    blank_config['cal_file'] = ''
    blank_config['crystal_energy_root_file'] = ''
    with open(filename, 'w') as json_file:
        json.dump(blank_config,
                  json_file,
                  ensure_ascii=True,
                  sort_keys=True,
                  indent=4,
                  separators=(',', ': '))
        json_file.write('\n')
    quit()

def auto_generate_config(base_name):
    files = os.listdir('.')

    # Find any config file that would have been created by breastdaq
    config_files_rx = re.compile('^DAQ_Config_[0-9]{10}.json$')
    config_files = sorted(
            [l for l in files for m in [config_files_rx.search(l)] if m])

    config_file = '/home/miil/FINDATA/nfo/breast_daq_config.json'
    if len(config_files) == 0:
        print 'No BreastDAQ config file found.  Using system default: %s' % config_file
        if type(base_name) is not str:
            base_name = str(raw_input('Enter base name to use for calibration: '))
    elif len(config_files) > 1:
        print 'Found Multiple BreastDAQ config files, input one: ', config_files
        config_file = str(raw_input('Enter config: '))
    else:
        config_file = config_files[0]

    if type(base_name) is not str:
        base_name = config_file.replace('_Config_', '_Calib_').replace('.json', '')

    # find the daq files
    daq_files_rx = re.compile('^DAQ_Data_[0-9]{10}_[L,R][0-9]_[0-9]{1,3}.dat$')
    daq_files = sorted(
            [l for l in files for m in [daq_files_rx.search(l)] if m])

    dec_files = [s.replace('.dat','.dat.dec') for s in daq_files]
    cal_files = [s.replace('.dat','.dat.cal') for s in daq_files]

    # find all the pedestal files
    ped_files_rx = re.compile('^PED_Data_[0-9]{10}_[L,R][0-9]_[0-9]{1,3}.dat$')
    ped_files = sorted(
            [l for l in files for m in [ped_files_rx.search(l)] if m])

    new_config = dict()
    new_config['config_file'] = config_file
    new_config['ped_filelist'] = base_name + '.filelist.ped.txt'
    new_config['ped_file'] = base_name + '.ped'
    new_config['filelist'] = base_name + '.filelist.daq.txt'
    new_config['dec_filelist'] = base_name + '.filelist.dec.txt'
    new_config['cal_filelist'] = base_name + '.filelist.cal.txt'
    new_config['uv_file'] = base_name + '.uv'
    new_config['pp_file'] = base_name + '.pp'
    new_config['pp_root_file'] = base_name + '.pp.root'
    new_config['flood_root_file'] = base_name + '.floods.root'
    new_config['loc_file'] = base_name + '.loc'
    new_config['graphs_root_file'] = base_name + '.graphs.root'
    new_config['cal_file'] = base_name + '.cal'
    new_config['crystal_energy_root_file'] = base_name + '.xpp.root'


    cal_json_name = base_name + '.json'

    with open(cal_json_name, 'w') as json_file:
        json.dump(new_config,
                  json_file,
                  ensure_ascii=True,
                  sort_keys=True,
                  indent=4,
                  separators=(',', ': '))
        json_file.write('\n')

    with open(new_config['ped_filelist'], 'w') as f:
        f.write('\n'.join(ped_files) + '\n')
    with open(new_config['filelist'], 'w') as f:
        f.write('\n'.join(daq_files) + '\n')
    with open(new_config['dec_filelist'], 'w') as f:
        f.write('\n'.join(dec_files) + '\n')
    with open(new_config['cal_filelist'], 'w') as f:
        f.write('\n'.join(cal_files) + '\n')

    print 'Check if the generated config (%s) and filelists look correct' % \
            cal_json_name
    print 'Then execute "run_calibration -c %s [-a -ff ...]"' % cal_json_name
    quit()

parser = parse_args()
args = parser.parse_args()


# Check first if the user wanted to generate a template to work from
if args.blank:
    generate_blank_config(args.blank)
# Or if we should try and generate one from the current directory
if args.generate:
    auto_generate_config(args.generate)


# Then make sure they had specified a json config file
if args.config is None:
    parser.print_help()
    quit()

# And then load that config
with open(args.config,'r') as json_file:
    cal_info = json.load(json_file)


if args.decode:
    popens = []
    with open(cal_info['filelist']) as f:
        daq_files = f.read().splitlines()
    for f in daq_files:
        decode_cmd = 'decode -c %s -p %s -f %s' % (
                cal_info['config_file'],
                cal_info['ped_file'], f)
        print decode_cmd
        if not args.simulate:
            popens.append(subprocess.Popen([decode_cmd], shell=True))

        # If we have args.cores instances running, then wait until the first one
        # gets done before we continue
        if len(popens) >= args.cores:
            popens[0].wait()
            popens.pop(0)

    # Wait for the processes to finish up
    for popen in popens:
        popen.wait()


if args.calibrate:
    popens = []
    with open(cal_info['filelist']) as f:
        daq_files = f.read().splitlines()
    for f in daq_files:
        cal_cmd = 'decode -c %s -p %s -cal %s -uv %s -f %s' % (
                cal_info['config_file'],
                cal_info['ped_file'],
                cal_info['cal_file'],
                cal_info['uv_file'], f)
        print cal_cmd
        if not args.simulate:
            popens.append(subprocess.Popen([cal_cmd], shell=True))

        # If we have args.cores instances running, then wait until the first one
        # gets done before we continue
        if len(popens) >= args.cores:
            popens[0].wait()
            popens.pop(0)

    # Wait for the processes to finish up
    for popen in popens:
        popen.wait()

if args.all:
    args.pedestals = True
    args.uv = True
    args.apd_photopeaks = True
    args.fill_floods = True
    args.fit_floods = True
    args.crystal_photopeaks = True

if args.pedestals:
    ped_cmd = 'pedestals -v -c %s -l %s -o %s' % (
            cal_info['config_file'],
            cal_info['ped_filelist'],
            cal_info['ped_file'])
    print ped_cmd
    if not args.simulate:
        ped_popen = subprocess.Popen([ped_cmd], shell=True)
        ped_popen.wait()

if args.uv:
    filelist = cal_info['filelist']
    if args.assume_decoded:
        filelist = cal_info['dec_filelist']
    uv_cmd = 'calc_uv -v -c %s -p %s -l %s -o %s' % (
            cal_info['config_file'],
            cal_info['ped_file'],
            filelist,
            cal_info['uv_file'])
    if args.assume_decoded:
        uv_cmd += ' -ad'
    print uv_cmd
    if not args.simulate:
        uv_popen = subprocess.Popen([uv_cmd], shell=True)
        uv_popen.wait()

if args.apd_photopeaks:
    filelist = cal_info['filelist']
    if args.assume_decoded:
        filelist = cal_info['dec_filelist']
    apd_cmd = 'get_apd_photopeaks -v -c %s -p %s -l %s -o %s -ro %s' % (
            cal_info['config_file'],
            cal_info['ped_file'],
            filelist,
            cal_info['pp_file'],
            cal_info['pp_root_file'])
    if args.assume_decoded:
        apd_cmd += ' -ad'
    print apd_cmd
    if not args.simulate:
        apd_popen = subprocess.Popen([apd_cmd], shell=True)
        apd_popen.wait()

if args.fill_floods:
    filelist = cal_info['filelist']
    if args.assume_decoded:
        filelist = cal_info['dec_filelist']
    fill_cmd = 'fill_floods -v -c %s -p %s -l %s -pp %s -o %s' % (
            cal_info['config_file'],
            cal_info['ped_file'],
            filelist,
            cal_info['pp_file'],
            cal_info['flood_root_file'])
    if args.assume_decoded:
        fill_cmd += ' -ad'
    print fill_cmd
    if not args.simulate:
        fill_popen = subprocess.Popen([fill_cmd], shell=True)
        fill_popen.wait()

if args.fit_floods:
    fit_cmd = 'fit_floods -v -c %s -f %s -o %s -ro %s' % (
            cal_info['config_file'],
            cal_info['flood_root_file'],
            cal_info['loc_file'],
            cal_info['graphs_root_file'])
    print fit_cmd
    if not args.simulate:
        fit_popen = subprocess.Popen([fit_cmd], shell=True)
        fit_popen.wait()

if args.crystal_photopeaks:
    filelist = cal_info['filelist']
    if args.assume_decoded:
        filelist = cal_info['dec_filelist']
    cry_cmd = 'get_crystal_photopeaks -v -c %s -p %s -pp %s -x %s -l %s -o %s -ro %s' % (
            cal_info['config_file'],
            cal_info['ped_file'],
            cal_info['pp_file'],
            cal_info['loc_file'],
            filelist,
            cal_info['cal_file'],
            cal_info['crystal_energy_root_file'])
    if args.assume_decoded:
        cry_cmd += ' -ad'
    print cry_cmd
    if not args.simulate:
        cry_popen = subprocess.Popen([cry_cmd], shell=True)
        cry_popen.wait()
